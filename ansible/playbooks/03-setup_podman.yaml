- name: Bootstrap PVE server
  hosts: [podman]
  become: true
  roles:
    - pve_server

- name: Setup application user and group
  hosts: [podman]
  become: true
  tasks:
  - name: Check if user is lingering
    ansible.builtin.stat:
      path: "/var/lib/systemd/linger/podman-user"
    register: user_lingering

  - name: Enable lingering for user
    ansible.builtin.command: "loginctl enable-linger podman-user"
    changed_when: true
    when: not user_lingering.stat.exists
  
  - name: Configure /etc/subuid and /etc/subgid for podman user
    ansible.builtin.lineinfile:
      path: "{{ sub_file }}"
      line: "podman-user:100000:65536"
      create: yes
      state: present
    register: subuid_config
    loop: 
      - "/etc/subuid"
      - "/etc/subgid"
    loop_control:
      loop_var: sub_file

  - name: Create systemd folders for application user
    ansible.builtin.file:
      path: "{{ item }}"
      state: directory
      mode: '0755'
      owner: podman-user
      group: podman-user
      recurse: true
    loop:
      - /home/podman-user/.config/containers/systemd
      - /home/podman-user/.config/quadsyncd
      - /home/podman-user/.local/state/quadsyncd
  
- name: Setup firewall rules for privileged ports
  hosts: [podman]
  become: true
  tasks:
  - name: Install firewalld
    ansible.builtin.package:
      name: firewalld
      state: present
  
  - name: Ensure firewalld is started and enabled
    ansible.builtin.service:
      name: firewalld
      state: started
      enabled: true

  - name: Install python firewall module
    ansible.builtin.package:
      name: python3-firewall
      state: present

  - name: Redirect privileged ports to non-privileged ports using firewalld
    ansible.posix.firewalld:
      rich_rule: rule family=ipv4 forward-port port={{ fw_rule.port }} protocol=tcp to-port={{ fw_rule.to_port }}
      zone: public
      permanent: true
      immediate: true
      state: enabled
    loop:
      - { port: 80, to_port: 8080 }
      - { port: 443, to_port: 8443 }
    loop_control:
      loop_var: fw_rule

- name: Configure podman user space
  hosts: [podman]
  tasks:
  - name: Get UID of podman-user
    ansible.builtin.user:
      name: podman-user
      state: present
    register: podman_user_info

  - name: Enable podman.socket for user
    become_user: 'podman-user'
    become: true
    systemd: 
      name: "podman.socket"
      enabled: yes
      state: started
      scope: user
    environment:
      XDG_RUNTIME_DIR: "/run/user/{{ podman_user_info.uid }}"
  
  - name: Setup socket activation units for HTTP/HTTPS traffic
    become_user: 'podman-user'
    become: true
    ansible.builtin.template:
      src: ./templates/systemd-socket.j2
      dest: /home/podman-user/.config/systemd/user/{{ item.name }}.socket
      mode: '0644'
    loop:
      - { name: "web", port: 8080 }
      - { name: "websecure", port: 8443 }
    register: socket_units

  - name: Reload systemd daemon
    become_user: 'podman-user'
    become: true
    ansible.builtin.systemd:
      daemon_reload: yes
      scope: user
    environment:
      XDG_RUNTIME_DIR: "/run/user/{{ podman_user_info.uid }}"
    when: socket_units.changed

  - name: Enable HTTP/HTTPS socket units for user # don't start them yet, Traefik will activate them on demand
    become_user: 'podman-user'
    become: true
    ansible.builtin.systemd:
      name: "{{ item.name }}.socket"
      enabled: true
      scope: user
    environment:
      XDG_RUNTIME_DIR: "/run/user/{{ podman_user_info.uid }}"
    loop:
      - { name: "web" }
      - { name: "websecure" }

  - name: Generate quadsyncd configuration for podman user
    ansible.builtin.template:
      src: ./templates/quadsyncd.config.yaml
      dest: /home/podman-user/.config/quadsyncd/config.yaml
      mode: '0644'
      owner: podman-user
      group: podman-user

- name: Install Infisical CLI
  hosts: [podman]
  become: true
  tasks:
  - name: Install Infisical repositories
    ansible.builtin.shell: |
      curl -1sLf 'https://dl.cloudsmith.io/public/infisical/infisical-cli/setup.rpm.sh' | sudo -E bash
    args:
      creates: /etc/yum.repos.d/infisical-infisical-cli.repo

  - name: Install Infisical CLI
    ansible.builtin.package:
      name: infisical
      state: present

- name: Create Infisical agent configuration
  hosts: [podman]
  become: true
  tasks:
  - name: Set facts
    ansible.builtin.set_fact:
      infisical_server_url: "{{ lookup('env', 'TF_VAR_infisical_server_url') }}"
      infisical_project_id: "{{ lookup('env', 'TF_VAR_infisical_project_id') }}"
      infisical_client_id: "{{ lookup('env', 'TF_VAR_infisical_client_id') }}"
      infisical_client_secret: "{{ lookup('env', 'TF_VAR_infisical_client_secret') }}"

  - name: Ensure Infisical agent configuration directory exists
    ansible.builtin.file:
      path: /etc/infisical-agent
      state: directory
      mode: '0755'
      owner: root
      group: root

  - name: Render secret update script template from template
    ansible.builtin.template:
      src: ./templates/podman-secret-template.sh.tpl.j2
      dest: /etc/infisical-agent/podman-secret.sh.tpl
      mode: '0700'
      owner: root
      group: root
    vars:
      project_id: "{{ infisical_project_id }}"
  
  - name: Copy Infisical agent configuration and secret update script
    ansible.builtin.copy:
      src: "./files/{{ item.src }}"
      dest: "{{ item.dest }}"
      mode: '0644'
      owner: root
      group: root
    loop:
      - { src: "infisical-agent-config.yaml", dest: "/etc/infisical-agent/config.yaml" }
      - { src: "update-podman-secrets.sh", dest: "/etc/infisical-agent/update-secrets.sh" }
  
  - name: Ensure secret update script is executable
    ansible.builtin.file:
      path: /etc/infisical-agent/update-secrets.sh
      mode: '0755'
      owner: root
      group: root
  
  - name: Ensure storage directory for agent secrets exists
    ansible.builtin.file:
      path: /etc/infisical-agent/secrets
      state: directory
      mode: '0700'
      owner: root
      group: root

- name: Install & start Infisical agent service
  hosts: [podman]
  become: true
  tasks:
  - name: Create secret files from facts
    ansible.builtin.copy:
      dest: /etc/infisical-agent/secrets/{{ item.key }}
      content: "{{ item.value }}"
      mode: '0600'
      owner: root
      group: root
    loop:
      - { key: "client-secret", value: "{{ infisical_client_secret }}" }
      - { key: "client-id", value: "{{ infisical_client_id }}" }

  - name: Copy systemd service file for Infisical agent
    ansible.builtin.copy:
      src: ./files/infisical-agent.service
      dest: /etc/systemd/system/infisical-agent.service
      mode: '0644'
    register: infisical_agent_service
  
  - name: Reload systemd daemon
    ansible.builtin.systemd:
      daemon_reload: yes
    when: infisical_agent_service.changed

  - name: Ensure Infisical agent service is started and enabled
    ansible.builtin.service:
      name: infisical-agent
      state: started
      enabled: true
  
  - name: Wait for Infisical agent to render first import script
    ansible.builtin.wait_for:
      path: /tmp/ensure-podman-secrets.sh
      state: present
      timeout: 60
  
  - name: Execute update script to import secrets into podman
    ansible.builtin.command: "/bin/bash /etc/infisical-agent/update-secrets.sh"
